<style>.dg{color:black;position:relative;visibility:hidden}.dg-h-container{overflow:hidden;border:1px solid #E0E0E0}.dg-h-body{overflow:hidden;overflow-x:auto;overflow-scrolling:touch;-webkit-overflow-scrolling:touch;-moz-overflow-scrolling:touch;-ms-overflow-scrolling:touch;-webkit-overflow-scrolling:touch}.dg-header{position:relative}.dg-hrow{height:58px;border-bottom:1px solid #E0E0E0}.dg-hcol{float:left;border-left:1px solid #E0E0E0;height:58px;font-weight:bold;position:relative}.dg-sort{float:right;font-size:11px;width:20px;text-align:center;padding:11px 0 0;color:#4285F4}.dg-btn-columns{cursor:pointer;color:#D0D0D0;font-size:20px;position:absolute;right:0;height:58px;background-color:#D0D0D0;width:12px;text-align:left;z-index:3}.dg-btn-columns span{display:block;padding-top:4px;font-size:6px;color:gray;text-align:center}.dg-btn-columns i{position:absolute;margin-left:-5px;top:26px}.dg-btn-columns:hover{background-color:#D9D9D9;color:#D9D9D9}.dg-sorting{cursor:pointer}.dg-sorting .fa-sort{color:gray}.dg-hcol:first-child{border-left:0}.dg-resize{position:absolute;width:10px;cursor:col-resize;height:34px;border-right:1px solid #D0D0D0;z-index:2}.dg-label{padding:8px 5px 0;height:34px;font-size:12px;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.dg-sorting .dg-label.center{padding-left:25px;padding-right:0}.dg-sorting .dg-label{margin-right:24px}.dg-filter{padding:0 5px;border-top:1px solid #E0E0E0;height:23px}.dg-filter input,.dg-filter label{width:100%;outline:0;font-size:10px;background-color:transparent;border:0;margin:0;padding:0;line-height:23px;height:23px}.dg-filter label{color:#A0A0A0;cursor:pointer;display:block}.dg-filter.center input{text-align:center}.dg-filter.right input{text-align:right}.dg-filter-empty{border-top:1px solid #E0E0E0;height:23px;cursor:not-allowed !important;background:-webkit-repeating-linear-gradient(45deg,#FFFFFF,#FFFFFF 10px,#F9F9F9 10px,#F9F9F9 20px);background:-moz-repeating-linear-gradient(45deg,#FFFFFF,#FFFFFF 10px,#F9F9F9 10px,#F9F9F9 20px);background:-ms-repeating-linear-gradient(45deg,#FFFFFF,#FFFFFF 10px,#F9F9F9 10px,#F9F9F9 20px);background:repeating-linear-gradient(45deg,#FFFFFF,#FFFFFF 10px,#F9F9F9 10px,#F9F9F9 20px)}.dg-hcol .dg-label{padding-top:9px}.dg-filter-selected{background-color:#FBF0CA !important}.dg-filter-selected label{color:black}.dg-filter i{position:absolute;right:5px;margin-top:6px;font-size:10px;color:red;display:none;cursor:pointer}.dg-filter-selected i{display:block}.dg-filter-selected input{padding-right:12px}.dg-clickable .dg-row{cursor:pointer}.dg-v-area{overflow:hidden}.dg-v-container{overflow:hidden}.dg-v-body{overflow-y:auto;overflow-scrolling:touch;-webkit-overflow-scrolling:touch;-moz-overflow-scrolling:touch;-ms-overflow-scrolling:touch;-webkit-overflow-scrolling:touch;overflow-x:hidden;outline:0 !important}.dg-row{height:28px;font-size:12px;border-bottom:1px solid #E0E0E0}.dg-row-changed{background-color:rgba(208,31,33,0.07)}.dg-row.dg-selected{background-color:rgba(249,232,196,0.5) !important}.dg-row:hover{background-color:rgba(0,0,0,0.05) !important}.dg-col{float:left;border-left:1px solid #E0E0E0;height:27px;overflow:hidden;min-width:30px}.dg-col:first-child{border-left:0}.dg-col-changed{background-image:url(data:image/gif;base64,R0lGODdhBgAGAIAAAP8mAAAAACH5BAEAAAEALAAAAAAGAAYAAAIKhI8QGGvt4JKhAAA7);background-repeat:no-repeat;background-position:0 0}.dg-value{padding:6px 5px 0;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;height:28px}.dg-number{padding:6px 5px 0;font-size:11px;text-align:right;height:28px;color:#A0A0A0}.dg-col--1{width:40px}.dg-col--1 .dg-label{text-overflow:clip}.dg-row-empty{height:28px;font-size:12px;border-bottom:1px solid #F0F0F0;background-color:white !important;cursor:default}.dg-footer{border:1px solid #E0E0E0;border-top:0;height:32px}.dg-pagination{float:left}.dg-pagination button{background-color:#FFF;border:0;border-left:1px solid #E0E0E0;height:31px;width:40px;color:black;font-size:12px;text-align:center;outline:0}.dg-pagination button:hover{background-color:#F0F0F0}.dg-pagination button:disabled{background-color:#F9F9F9;color:#A0A0A0}.dg-pagination button:first-child{border-left:0}.dg-pagination button[name="page-prev"]{border-right:1px solid #E0E0E0;width:41px}.dg-pagination button[name="page-last"]{border-right:1px solid #E0E0E0}.dg-pagination input{width:40px;text-align:center;border:0;outline:0;font-size:12px;padding:0;margin:0;background:transparent}.dg-pagination > div{position:relative;display:inline-block}.dg-pagination-items{float:right;font-size:12px;margin:7px 10px 0 0;font-weight:bold}.dg-pagination-pages{float:left;font-size:12px;margin:7px 0 0 10px}.dg-scrollbar-container-v{position:absolute;right:0;top:58px;width:6px;background-color:#D0D0D0;z-index:3;overflow:hidden;cursor:grab}.dg-scrollbar-v{width:100%;height:30px;background-color:gray;position:absolute;left:0;top:0}.dg-scrollbar-container-h{position:relative;height:6px;background-color:#D0D0D0;overflow:hidden;cursor:grab}.dg-scrollbar-h{height:100%;width:30px;background-color:gray;position:absolute;left:0;bottom:0}.dg-scroll-h .dg-h-container{border-bottom:0}.dg-noscroll .dg-v-body{overflow:hidden}.dg-noscroll .dg-scrollbar-container-v{display:none}.dg-visible{visibility:visible}.dg-columns:before{content:' ';position:absolute;width:0;height:0;margin-top:-8px;margin-left:158px;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid #404040}.dg-columns{position:absolute;right:0;top:43px;width:182px;background-color:#404040;z-index:1;box-shadow:0 5px 10px rgba(0,0,0,0.1);border-radius:2px;font-size:12px;line-height:16px;z-index:4;color:white}.dg-columns > div{border-bottom:1px solid #303030;overflow:hidden}.dg-columns-body{max-height:180px;overflow-scrolling:touch;-webkit-overflow-scrolling:touch;-moz-overflow-scrolling:touch;-ms-overflow-scrolling:touch;overflow-y:auto;padding:8px 50px 10px 10px;width:210px;overflow-x:hidden}.dg-columns label{display:block;cursor:pointer;overflow-x:hidden;text-overflow:ellipsis;white-space:nowrap}.dg-columns label input{vertical-align:middle}.dg-columns label span{vertical-align:middle;margin-left:5px}.dg-columns-button{margin:10px 10px 0;display:block;width:160px;background-color:#888888;border-radius:2px;color:white;border:0;font-size:11px;height:20px}.dg-columns-button:hover{background-color:#999999}.dg-columns-button i{margin-right:6px}.dt-columns-reset{display:block;font-size:11px;padding:5px 0 8px 10px;cursor:pointer}.dt-columns-reset:hover{text-decoration:underline}.dg-hcol .dg-checkbox{margin-top:0}.dg-checkbox{width:15px;height:15px;border:1px solid #D0D0D0;vertical-align:middle;cursor:pointer;font-size:11px;text-align:center;padding:1px 0 0 1px;background-color:white;border-radius:2px;margin:5px auto 0}.dg-checkbox i{display:none}.dg-checked{background-color:#4285F4;border-color:#4285F4;color:white}.dg-checked i{display:block}.dg-required:before{content:'*';font-size:14px;color:red;font-weight:bold;margin-right:3px;vertical-align:top}.dg input:-ms-input-placeholder{color:#A0A0A0 !important}.dg input::placeholder{color:#A0A0A0;opacity:1;filter:alpha(opacity=100)}.dg input::-ms-input-placeholder{color:#A0A0A0 !important}.dg-col button{margin:4px 0 0;border:0;background-color:white;font-size:10px;color:#404040;height:19px;border:1px solid #E0E0E0;border-left:0;padding:0 3px;outline:0;line-height:10px;min-width:20px}.dg-col button:hover{background-color:#4285F4;color:white}.dg-col button[name="remove"]{background-color:#ffe5dd;color:red}.dg-col button[name="remove"]:hover{background-color:red;color:white}.dg-col button:first-child{border-top-left-radius:3px;border-bottom-left-radius:3px;border-left:1px solid #E0E0E0}.dg-col button:last-child{border-top-right-radius:3px;border-bottom-right-radius:3px}.dg-col button:disabled{background-color:#F0F0F0 !important;color:silver !important;cursor:not-allowed}.dg-editable .dg-checkbox{position:relative;display:inline-block;margin-left:5px;margin-right:5px}.dg-editable > div > .dg-checkbox{border-color:#4285F4}.dg-bool{height:28px}.dg-bool .dg-checked{background-color:#D0D0D0;border-color:#D0D0D0;color:gray}.dg-editable{background-color:rgba(255,241,164,0.1)}.dg-editable input{width:100%;height:28px;background-color:transparent;border:0;outline:0;padding:0 4px}.dg-scrollbar-container-v:hover, .dg-scrollbar-container-v-focused{width:12px}.dg-scrollbar-container-h:hover, .dg-scrollbar-container-h-focused{height:12px;margin-top:-6px;z-index:4}.dg-noborder .dg-h-container{border:0}.dg-noborder .dg-footer{border:0;border-top:1px solid #E0E0E0}.ui-dark .dg-noborder .dg-footer{border-color:#404040}.ui-dark .dg-filter-selected{background-color:#3c3a32 !important;color:white}.ui-dark .dg-filter-selected label{color:white}.ui-dark .dg{color:#E0E0E0}.ui-dark .dg-h-container{border-color:#353535}.ui-dark .dg-sorting .fa-sort{color:#A0A0A0}.ui-dark .dg-filter{border-top-color:#353535}.ui-dark .dg-resize{border-right-color:#353535}.ui-dark .dg-filter-empty{border-top-color:#353535;height:23px;background:-webkit-repeating-linear-gradient(45deg,#252525,#252525 10px,#202020 10px,#202020 20px);background:-moz-repeating-linear-gradient(45deg,#252525,#252525 10px,#202020 10px,#202020 20px);background:-ms-repeating-linear-gradient(45deg,#252525,#252525 10px,#202020 10px,#202020 20px);background:repeating-linear-gradient(45deg,#252525,#252525 10px,#202020 10px,#202020 20px)}.ui-dark .dg-number{background-color:#282828}.ui-dark .dg-col{border-left-color:#353535}.ui-dark .dg-hcol{border-left-color:#353535}.ui-dark .dg-hrow{border-bottom-color:#353535;color:#F0F0F0}.ui-dark .dg-row-empty{background-color:#202020 !important;border-bottom-color:#353535}.ui-dark .dg-row{border-bottom-color:#353535}.ui-dark .dg-selected{background-color:rgba(200,200,200,0.03) !important}.ui-dark .dg-v-body > div > div:nth-child(even) > .dg-row{background-color:rgba(0,0,0,0.1)}.ui-dark .dg-row:hover{background-color:rgba(0,0,0,0.2)}.ui-dark .dg-row-changed:hover{background-color:rgba(208,31,33,0.2) !important}.ui-dark .dg-row-changed{background-color:rgba(208,31,33,0.12) !important}.ui-dark .dg-row-changed.dg-row:nth-child(even){background-color:rgba(208,31,33,0.12)}.ui-dark .dg-scrollbar-container-h{background-color:#282828}.ui-dark .dg-scrollbar-container-v{background-color:#282828}.ui-dark .dg-scrollbar-h{background-color:#454545}.ui-dark .dg-scrollbar-v{background-color:#454545}.ui-dark .dg-btn-columns:hover{color:white}.ui-dark .dg-col button{background-color:#303030;color:#A0A0A0;border-color:#404040}.ui-dark .dg-col button:hover{background-color:#404040;color:white}.ui-dark .dg-col button:first-child{border-left-color:#404040}.ui-dark .dg-col button[name="remove"]{background-color:#282828;color:red}.ui-dark .dg-col button:disabled{background-color:#252525 !important;color:#505050 !important}.ui-dark .dg-checkbox{background-color:#303030;border-color:#3A3A3A}.ui-dark .dg-checked{background-color:#4285F4;border-color:#4285F4;color:white}.ui-dark .dg-btn-columns{color:#323232;background-color:#323232}.ui-dark .dg-btn-columns span{color:#606060}.ui-dark .dg-btn-columns:hover{background-color:#353535;color:#353535}.ui-dark .dg-pagination button{background-color:#303030;border-left-color:#404040;color:white}.ui-dark .dg-pagination button:hover{background-color:#353535}.ui-dark .dg-pagination button:disabled{background-color:#202020;color:gray}.ui-dark .dg-pagination button[name="page-prev"]{border-right-color:#404040}.ui-dark .dg-pagination button[name="page-last"]{border-right-color:#404040}.ui-dark .dg-bool .dg-checked{background-color:#505050;border-color:#505050;color:gray}.ui-dark .dg-editable{background-color:rgba(255,241,164,0.05)}</style>
<script>COMPONENT('datagrid@1','checkbox:true;colwidth:150;rowheight:28;clusterize:true;limit:80;filterlabel:Filter;height:auto;bottom:90;resize:true;reorder:true;sorting:true;boolean:true,on,yes;pluralizepages:# pages,# page,# pages,# pages;pluralizeitems:# items,# item,# items,# items;remember:true;highlight:false;unhighlight:true;autoselect:false;buttonapply:Apply;buttonreset:Reset;allowtitles:false;fullwidth_xs:true;clickid:id;dirplaceholder:Search',function(self,config){var opt={filter:{},filtercache:{},filtercl:{},filtervalues:{},scroll:false,selected:{},operation:''},header,vbody,footer,vcontainer,hcontainer,varea,hbody,vscrollbar,vscrollbararea,hscrollbar,hscrollbararea,ecolumns,isecolumns=false,Theadercol=Tangular.compile('<div class="dg-hcol dg-col-{{ index}}{{ if sorting}} dg-sorting{{ fi}}" data-index="{{ index}}">{{ if sorting}}<i class="dg-sort fa fa-sort"></i>{{ fi}}<div class="dg-label{{ alignheader}}"{{ if labeltitle}} title="{{ labeltitle}}"{{ fi}}{{ if reorder}} draggable="true"{{ fi}}>{{ label | raw}}</div>{{ if filter}}<div class="dg-filter{{ alignfilter}}{{ if filterval != null && filterval !== \'\' }} dg-filter-selected{{ fi}}"><i class="fa dg-filter-cancel fa-times"></i>{{ if options}}<label data-name="{{ name}}">{{ if filterval}}{{ filterval}}{{ else}}{{ filter}}{{ fi}}</label>{{ else}}<input autocomplete="new-password" type="text" placeholder="{{ filter}}" class="dg-filter-input" name="{{ name}}{{ ts}}" data-name="{{ name}}" value="{{ filterval}}" />{{ fi}}</div>{{ else}}<div class="dg-filter-empty">&nbsp;</div>{{ fi}}</div>');var isIE=(/msie|trident/i).test(navigator.userAgent);var isredraw=false,sv={is:false},sh={is:false},pos={},forcescroll='',schemas={};self.meta=opt;function Cluster(el){var self=this,dom=el[0],scrollel=el;self.row=config.rowheight;self.rows=[];self.limit=config.limit;self.pos=-1;self.enabled=!!config.clusterize;self.plus=0;self.scrolltop=0;self.prev=0;var seh='<div style="height:0px"></div>',set=$(seh);var seb=$(seh);var div=document.createElement('DIV');dom.appendChild(set[0]);dom.appendChild(div);dom.appendChild(seb[0]);self.el=$(div);self.render=function(){var t=self.pos*self.frame,b=(self.rows.length*self.row)-(self.frame*2)-t;var pos=self.pos*self.limit,posto=pos+(self.limit*2);set.css('height',t);seb.css('height',b<2?2:b);if(self.prev<t)dom.scrollTop=t+5;self.prev=t;var node=self.el[0];node.innerHTML='';for(var i=pos;i<posto;i++){if(typeof(self.rows[i])==='string')self.rows[i]=$(self.rows[i])[0];if(self.rows[i])node.appendChild(self.rows[i]);else break}if(self.grid.selected){var index=opt.rows.indexOf(self.grid.selected);if(index!==-1&&(index>=pos||index<=(pos+self.limit)))self.el.find('.dg-row[data-index="{0}"]'.format(index)).aclass('dg-selected')}};self.scrolling=function(){var y=dom.scrollTop+1;self.scrolltop=y;if(y<0)return;var frame=Math.ceil(y/self.frame)-1;if(frame===-1)return;if(self.pos!==frame){var plus=(self.el[0].offsetHeight/2)-self.frame;if(plus>0){frame=Math.ceil(y/(self.frame+plus))-1;if(self.pos===frame)return}if(self.max&&frame>=self.max)frame=self.max;self.pos=frame;if(self.enabled)self.render();else{var node=self.el[0],child=node.firstChild;while(child){node.removeChild(child);child=node.firstChild}for(var i=0;i<self.rows.length;i++){if(typeof(self.rows[i])==='string')self.rows[i]=$(self.rows[i])[0];self.el[0].appendChild(self.rows[i])}}self.scroll&&self.scroll();config.change&&SEEX(self.makepath(config.change),null,null,self.grid)}};self.update=function(rows,noscroll){if(noscroll!=true)self.el[0].scrollTop=0;self.limit=config.limit;self.pos=-1;self.rows=rows;self.max=Math.ceil(rows.length/self.limit)-1;self.frame=self.limit*self.row;if(!self.enabled){self.frame=1000000}else if(self.limit*2>rows.length){self.limit=rows.length;self.frame=self.limit*self.row;self.max=1}self.scrolling()};self.destroy=function(){self.el.off('scroll');self.rows=null};scrollel.on('scroll',self.scrolling)}self.destroy=function(){opt.cluster&&opt.cluster.destroy()};self.init=function(){$(window).on('resize',function(){setTimeout2('datagridresize',function(){SETTER('datagrid','resize')},500)});Thelpers.ui_datagrid_checkbox=function(val){return'<div class="dg-checkbox'+(val?' dg-checked':'')+'" data-custom="1"><i class="fa fa-check"></i></div>'}};self.readonly();self.bindvisible();self.nocompile();var reconfig=function(){self.tclass('dg-clickable',!!(config.click||config.dblclick))};self.configure=function(key,value,init){switch(key){case'noborder':self.tclass('dg-noborder',!!value);break;case'checkbox':case'numbering':!init&&self.cols(NOOP);break;case'pluralizepages':config.pluralizepages=value.split(',').trim();break;case'pluralizeitems':config.pluralizeitems=value.split(',').trim();break;case'checked':case'button':case'exec':if(value&&value.SCOPE)config[key]=value.SCOPE(self,value);break;case'dblclick':if(value&&value.SCOPE)config.dblclick=value.SCOPE(self,value);break;case'click':if(value&&value.SCOPE)config.click=value.SCOPE(self,value);break;case'columns':self.datasource(value,function(path,value,type){if(value){opt.sort=null;opt.filter={};opt.scroll='';opt.selected={};self.rebind(value);type&&self.setter(null)}});break}setTimeout2(self.ID+'reconfigure',reconfig)};self.refresh=function(){self.refreshfilter()};self.applycolumns=function(use){isecolumns=false;ecolumns.aclass('hidden');if(use){var hidden={};ecolumns.find('input').each(function(){hidden[this.value]=!this.checked});self.cols(function(cols){for(var i=0;i<cols.length;i++){var col=cols[i];col.hidden=hidden[col.id]===true}})}};self.fn_in_changed=function(arr){config.changed&&SEEX(self.makepath(config.changed),arr||self.changed(),self)};self.fn_in_checked=function(arr){config.checked&&SEEX(self.makepath(config.checked),arr||self.checked(),self)};self.fn_refresh=function(){setTimeout2(self.ID+'filter',function(){if(config.exec)self.operation(opt.operation);else self.refreshfilter(true)},50)};self.make=function(){self.IDCSS=GUID(5);self.aclass('dg dg-noscroll dg-'+self.IDCSS);self.find('script').each(function(){var el=$(this);var id=el.attrd('id');if(id)schemas[id]=el.html();if(!schemas.default)schemas.default=el.html()});if(schemas.default){self.rebind(schemas.default);schemas.$current='default'}var pagination='';if(config.exec)pagination='<div class="dg-footer hidden"><div class="dg-pagination-items hidden-xs"></div><div class="dg-pagination"><button name="page-first" disabled><i class="fa fa-angle-double-left"></i></button><button name="page-prev" disabled><i class="fa fa-angle-left"></i></button><div><input type="text" name="page" maxlength="5" class="dg-pagination-input" /></div><button name="page-next" disabled><i class="fa fa-angle-right"></i></button><button name="page-last" disabled><i class="fa fa-angle-double-right"></i></button></div><div class="dg-pagination-pages"></div></div>';self.dom.innerHTML='<div class="dg-btn-columns"><i class="fa fa-caret-left"></i><span class="fa fa-columns"></span></div><div class="dg-columns hidden"><div><div class="dg-columns-body"></div></div><button class="dg-columns-button" name="columns-apply"><i class="fa fa-columns"></i>{1}</button><span class="dt-columns-reset">{2}</span></div><div class="dg-scrollbar-container-v invisible"><div class="dg-scrollbar-v invisible"></div></div><div class="dg-h-container"><div class="dg-h-body"><div class="dg-v-container"><div class="dg-v-area"><div class="dg-header"></div><div class="dg-v-body"></div></div></div></div></div><div class="dg-scrollbar-container-h invisible"><div class="dg-scrollbar-h invisible"></div></div>{0}'.format(pagination,config.buttonapply,config.buttonreset);varea=self.find('.dg-v-area');vcontainer=self.find('.dg-v-container');header=self.find('.dg-header');vbody=self.find('.dg-v-body');footer=self.find('.dg-footer');hbody=self.find('.dg-h-body');hcontainer=self.find('.dg-h-container');ecolumns=self.find('.dg-columns');vscrollbar=self.find('.dg-scrollbar-v');vscrollbararea=self.find('.dg-scrollbar-container-v');hscrollbar=self.find('.dg-scrollbar-h');hscrollbararea=self.find('.dg-scrollbar-container-h');opt.vbarsize=30;opt.hbarsize=30;pos.vscroll=vscrollbararea.css('top').parseInt();pos.hscroll=hscrollbararea.css('left').parseInt();var events={};events.mousemove=function(e){var p,scroll,half,off;if(sv.is){off=sv.offset;var y=(e.pageY-sv.y);if(e.pageY>sv.pos){half=sv.size/1.5>>0;if(off<half)off=half}p=(y/(sv.h-off))*100;scroll=((vbody[0].scrollHeight-opt.height)/100)*(p>100?100:p);vbody[0].scrollTop=Math.ceil(scroll);if(sv.counter++>10){sv.counter=0;sv.pos=e.pageY}if(p<-20||p>120)sv.is=false}else if(sh.is){off=sh.offset;var x=(e.pageX-sh.x);if(e.pageX>sh.pos){half=sh.size/1.5>>0;if(off<half)off=half}p=(x/(sh.w-off))*100;scroll=((hbody[0].scrollWidth-opt.width2)/100)*(p>100?100:p);hbody[0].scrollLeft=Math.ceil(scroll);if(sh.counter++>10){sh.counter=0;sh.pos=e.pageX}if(p<-20||p>120)sh.is=false}};events.mouseup=function(e){if(r.is){r.is=false;r.el.css('height',r.h);var x=r.el.css('left').parseInt();var index=+r.el.attrd('index');var width=opt.cols[index].width+(x-r.x);self.resizecolumn(index,width);e.preventDefault();e.stopPropagation()}else if(sv.is){sv.is=false;e.preventDefault();e.stopPropagation()}else if(sh.is){sh.is=false;e.preventDefault();e.stopPropagation()}vscrollbararea.rclass('dg-scrollbar-container-v-focused');hscrollbararea.rclass('dg-scrollbar-container-h-focused');events.unbind()};events.unbind=function(){$(window).off('mouseup',events.mouseup);$(window).off('mousemove',events.mousemove)};events.bind=function(){$(window).on('mouseup',events.mouseup);$(window).on('mousemove',events.mousemove)};vscrollbararea.on('mousedown',function(e){events.bind();var a='dg-scrollbar-container-v',el=$(e.target);if(el.hclass('dg-scrollbar-v')){el.parent().aclass(a+'-focused');sv.is=true;sv.y=self.element.offset().top+e.offsetY+60;sv.h=vscrollbararea.height();sv.pos=e.pageY;sv.offset=e.offsetY;sv.counter=0;e.preventDefault();e.stopPropagation()}else if(el.hclass(a)){el.aclass(a+'-focused');sv.is=false;sv.y=self.element.offset().top+pos.vscroll;sv.h=vscrollbararea.height();var y=(e.pageY-sv.y);var p=(y/sv.h)*100;var scroll=((vbody[0].scrollHeight-opt.height)/100)*p;var plus=(p/100)*opt.vbarsize;vbody[0].scrollTop=Math.ceil(scroll+plus);e.preventDefault();e.stopPropagation()}});hscrollbararea.on('mousedown',function(e){events.bind();var a='dg-scrollbar-container-h',el=$(e.target);if(el.hclass('dg-scrollbar-h')){el.parent().aclass(a+'-focused');sh.is=true;sh.x=self.element.offset().left+e.offsetX;sh.w=hscrollbararea.width();sh.pos=e.pageX;sh.offset=e.offsetX;sh.counter=0;e.preventDefault();e.stopPropagation()}else if(el.hclass(a)){el.aclass(a+'-focused');sh.is=false;sh.w=hscrollbararea.width();var x=e.offsetX,p=(x/sh.w)*100;var scroll=((hbody[0].scrollWidth-opt.width2)/100)*p;var plus=(p/100)*opt.hbarsize;hbody[0].scrollLeft=Math.ceil(scroll+plus);e.preventDefault();e.stopPropagation()}});var scrollcache={};scrollcache.scrollv=function(){vscrollbar.css('top',scrollcache.v+'px')};scrollcache.scrollh=function(){hscrollbar.css('left',scrollcache.h+'px')};var hidedir=function(){ishidedir=true;SETTER('!directory','hide');setTimeout(function(){ishidedir=false},800)};var ishidedir=false;vbody.on('scroll',function(e){var el=e.target,p=((el.scrollTop/(el.scrollHeight-opt.height))*100)>>0;var pos=(((opt.height-opt.vbarsize-(opt.hbar?10:0))/100)*p);if(pos<0)pos=0;else{var max=opt.height-opt.vbarsize;if(pos>max)pos=max}scrollcache.v=pos;W.requestAnimationFrame(scrollcache.scrollv);isecolumns&&self.applycolumns();!ishidedir&&hidedir()});hbody.on('scroll',function(e){var el=e.target,p=((el.scrollLeft/(el.scrollWidth-opt.width2))*100)>>0;var pos=(((opt.width2-opt.hbarsize)/100)*p);if(pos<0)pos=0;else{var max=opt.width2-opt.hbarsize;if(pos>max)pos=max}scrollcache.h=pos;W.requestAnimationFrame(scrollcache.scrollh);isecolumns&&self.applycolumns();!ishidedir&&hidedir()});var r={is:false};self.event('click','.dg-btn-columns',function(e){e.preventDefault();e.stopPropagation();var cls='hidden';if(isecolumns){self.applycolumns()}else{var builder=[];for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];(col.listcolumn&&!col.$hidden)&&builder.push('<div><label><input type="checkbox" value="{0}"{1} /><span>{2}</span></label></div>'.format(col.id,col.hidden?'':' checked',col.text))}ecolumns.find('.dg-columns-body')[0].innerHTML=builder.join('');ecolumns.rclass(cls);isecolumns=true}});header.on('click','label',function(){var el=$(this);var index=+el.closest('.dg-hcol').attrd('index');var col=opt.cols[index],opts=col.options instanceof Array?col.options:GET(col.options);var dir={};dir.element=el;dir.items=opts;dir.key=col.otext;dir.offsetX=-6;dir.offsetY=-2;dir.placeholder=config.dirplaceholder;dir.callback=function(item){var val=item[col.ovalue],is=val!=null&&val!=='',name=el.attrd('name');opt.filtervalues[col.id]=val;if(is){if(opt.filter[name]==val)return;opt.filter[name]=val}else delete opt.filter[name];delete opt.filtercache[name];opt.filtercl[name]=val;forcescroll=opt.scroll='y';opt.operation='filter';el.parent().tclass('dg-filter-selected',is);el.text(item[dir.key]||'');self.fn_refresh()};SETTER('directory','show',dir)});self.event('dblclick','.dg-col',function(e){e.preventDefault();e.stopPropagation();self.editcolumn($(this))});var dblclick={ticks:0,id:null,row:null};self.event('click','.dg-row',function(e){var now=Date.now();var el=$(this);var type=e.target.tagName,target=$(e.target);if((type==='DIV'||type==='SPAN')&&!target.closest('.dg-checkbox').length){var cls='dg-selected',elrow=el.closest('.dg-row');var index=+elrow.attrd('index');var row=opt.rows[index];if(row==null)return;if(config.dblclick&&dblclick.ticks&&dblclick.ticks>now&&dblclick.row===row){config.dblclick&&SEEX(self.makepath(config.dblclick),row,self,elrow,target);if(config.highlight&&self.selected!==row){opt.cluster.el.find('.'+cls).rclass(cls);self.selected=row;elrow.aclass(cls)}e.preventDefault();return}dblclick.row=row;dblclick.ticks=now+300;var rowarg=row;if(config.highlight){opt.cluster.el.find('.'+cls).rclass(cls);if(!config.unhighlight||self.selected!==row){self.selected=row;elrow.aclass(cls)}else rowarg=self.selected=null}config.click&&SEEX(self.makepath(config.click),rowarg,self,elrow,target)}});self.released=function(is){!is&&setTimeout(self.resize,500)};self.event('click','.dg-filter-cancel,.dt-columns-reset',function(){var el=$(this);if(el.hclass('dt-columns-reset'))self.resetcolumns();else{var tmp=el.parent();var input=tmp.find('input');if(input.length){input.val('');input.trigger('change');return}var label=tmp.find('label');if(label.length){tmp.rclass('dg-filter-selected');var index=+el.closest('.dg-hcol').attrd('index');var col=opt.cols[index],k=label.attrd('name');label.html(col.filter);forcescroll=opt.scroll='y';opt.operation='filter';delete opt.filter[k];delete opt.filtervalues[col.id];delete opt.filtercl[k];self.fn_refresh()}}});self.event('click','.dg-label,.dg-sort',function(){var el=$(this).closest('.dg-hcol');if(!el.find('.dg-sort').length)return;var index=+el.attrd('index');for(var i=0;i<opt.cols.length;i++){if(i!==index)opt.cols[i].sort=0}var col=opt.cols[index];switch(col.sort){case 0:col.sort=1;break;case 1:col.sort=2;break;case 2:col.sort=0;break}opt.sort=col;opt.operation='sort';forcescroll='-';if(config.exec)self.operation(opt.operation);else self.refreshfilter(true)});isIE&&self.event('keydown','input',function(e){if(e.keyCode===13)$(this).blur();else if(e.keyCode===27)$(this).val('')});self.event('mousedown',function(e){var el=$(e.target);if(!el.hclass('dg-resize'))return;events.bind();var offset=self.element.offset().left;r.el=el;r.offset=(hbody.scrollLeft()-offset)+10;var prev=el.prev();r.min=(prev.length?prev.css('left').parseInt():(config.checkbox?70:30))+50;r.h=el.css('height');r.x=el.css('left').parseInt();el.css('height',opt.height+config.bottom);r.is=true;e.preventDefault();e.stopPropagation()});header.on('mousemove',function(e){if(r.is){var x=e.pageX+r.offset-20;if(x<r.min)x=r.min;r.el.css('left',x);e.preventDefault();e.stopPropagation()}});var d={is:false};self.event('dragstart',function(e){!isIE&&e.originalEvent.dataTransfer.setData('text/plain',GUID())});self.event('dragenter dragover dragexit drop dragleave',function(e){e.stopPropagation();e.preventDefault();switch(e.type){case'drop':if(d.is){var col=opt.cols[+$(e.target).closest('.dg-hcol').attrd('index')];col&&self.reordercolumn(d.index,col.index)}d.is=false;break;case'dragenter':if(!d.is){d.index=+$(e.target).closest('.dg-hcol').attrd('index');d.is=true}return;case'dragover':return;default:return}});self.event('change','.dg-pagination-input',function(){var value=self.get();var val=+this.value;if(isNaN(val))return;if(val>=value.pages)val=value.pages;else if(val<1)val=1;value.page=val;forcescroll=opt.scroll='y';self.operation('page')});self.event('change','.dg-filter-input',function(){var input=this,$el=$(this);var el=$el.parent();var val=$el.val();var name=input.getAttribute('data-name');var col=opt.cols[+el.closest('.dg-hcol').attrd('index')];delete opt.filtercache[name];delete opt.filtercl[name];if(col.options){if(val)val=(col.options instanceof Array?col.options:GET(col.options))[+val][col.ovalue];else val=null}var is=val!=null&&val!=='';if(col)opt.filtervalues[col.id]=val;if(is){if(opt.filter[name]==val)return;opt.filter[name]=val}else delete opt.filter[name];forcescroll=opt.scroll='y';opt.operation='filter';el.tclass('dg-filter-selected',is);self.fn_refresh()});self.select=function(row){var index;if(typeof(row)==='number'){index=row;row=opt.rows[index]}else if(row)index=opt.rows.indexOf(row);var cls='dg-selected';if(!row||index===-1){self.selected=null;opt.cluster&&opt.cluster.el.find('.'+cls).rclass(cls);config.highlight&&config.click&&SEEX(self.makepath(config.click),null,self);return}self.selected=row;var elrow=opt.cluster.el.find('.dg-row[data-index="{0}"]'.format(index));if(elrow&&config.highlight){opt.cluster.el.find('.'+cls).rclass(cls);elrow.aclass(cls)}config.click&&SEEX(self.makepath(config.click),row,self,elrow,null)};self.event('click','.dg-checkbox',function(){var t=$(this);var custom=t.attrd('custom');if(custom==='1')return;t.tclass('dg-checked');if(custom==='2')return;var val=t.attrd('value');var checked=t.hclass('dg-checked');if(val==='-1'){if(checked){opt.checked={};for(var i=0;i<opt.rows.length;i++)opt.checked[opt.rows[i].ROW]=1}else opt.checked={};self.scrolling()}else if(checked)opt.checked[val]=1;else delete opt.checked[val];self.fn_in_checked()});self.event('click','button',function(e){switch(this.name){case'columns-apply':self.applycolumns(true);break;case'page-first':forcescroll=opt.scroll='y';self.get().page=1;self.operation('page');break;case'page-last':forcescroll=opt.scroll='y';var tmp=self.get();tmp.page=tmp.pages;self.operation('page');break;case'page-prev':forcescroll=opt.scroll='y';self.get().page-=1;self.operation('page');break;case'page-next':forcescroll=opt.scroll='y';self.get().page+=1;self.operation('page');break;default:var el=$(this);var row=opt.rows[+el.closest('.dg-row').attrd('index')];config.button&&SEEX(self.makepath(config.button),this.name,row,el,e);break}});config.exec&&self.operation('init')};self.operation=function(type){var value=self.get();if(value==null)value={};if(type==='filter'||type==='init')value.page=1;var keys=Object.keys(opt.filter);SEEX(self.makepath(config.exec),type,keys.length?opt.filter:null,opt.sort&&opt.sort.sort?[(opt.sort.name+'_'+(opt.sort.sort===1?'asc':'desc'))]:null,value.page,self);switch(type){case'sort':self.redrawsorting();break}};function align(type){return type===1?'center':type===2?'right':type}self.clear=function(){for(var i=0;i<opt.rows.length;i++)opt.rows[i].CHANGES=undefined;self.renderrows(opt.rows,true);opt.cluster&&opt.cluster.update(opt.render);self.fn_in_changed()};self.editcolumn=function(rindex,cindex){var col,row;if(cindex==null){if(rindex instanceof jQuery){cindex=rindex.attr('class').match(/\d+/);if(cindex)cindex=+cindex[0];else return;col=rindex}}else row=opt.cluster.el.find('.dg-row-'+(rindex+1));if(!col)col=row.find('.dg-col-'+cindex);var index=cindex;if(index==null)return;if(!row)row=col.closest('.dg-row');var data={};data.col=opt.cols[index];if(!data.col.editable)return;data.rowindex=+row.attrd('index');data.row=opt.rows[data.rowindex];data.colindex=index;data.value=data.row[data.col.name];data.elrow=row;data.elcol=col;var clone=col.clone();var cb=function(data){if(data==null){col.replaceWith(clone);return}data.row[data.col.name]=data.value;if(opt.rows[data.rowindex]!=data.row)opt.rows[data.rowindex]=data.row;if(!data.row.CHANGES)data.row.CHANGES={};data.row.CHANGES[data.col.name]=true;opt.render[data.rowindex]=$(self.renderrow(data.rowindex,data.row))[0];data.elrow.replaceWith(opt.render[data.rowindex]);self.fn_in_changed()};if(config.change)EXEC(self.makepath(config.change),data,cb,self);else self.datagrid_edit(data,cb)};self.applyfilter=function(obj,add){if(!add)opt.filter={};header.find('input,select').each(function(){var t=this,el=$(t);var val=obj[el.attrd('name')];if(val!==undefined){if(t.tagName==='SELECT'){var col=opt.cols.findItem('index',+el.closest('.dg-hcol').attrd('index'));if(col&&col.options){var index=col.options.findIndex(col.ovalue,val);if(index>-1)el.val(index)}}else el.val(val==null?'':val)}}).trigger('change')};self.rebind=function(code){if(code.length<30&&code.indexOf(' ')===-1){schemas.$current=code;schemas[code]&&self.rebind(schemas[code]);return}opt.declaration=code;var type=typeof(code);if(type==='string'){code=code.trim();self.gridid='dg'+HASH(code)}else self.gridid='dg'+HASH(JSON.stringify(code));var cache=config.remember?W.PREF?W.PREF.get(self.gridid):CACHE(self.gridid):null;var cols=type==='string'?new Function('return '+code)():CLONE(code);var tmp;opt.rowclasstemplate=null;opt.search=false;for(var i=0;i<cols.length;i++){var col=cols[i];if(typeof(col)==='string'){opt.rowclasstemplate=Tangular.compile(col);cols.splice(i,1);i--;continue}col.id=GUID(5);col.realindex=i;if(!col.name)col.name=col.id;if(col.listcolumn==null)col.listcolumn=true;if(col.hidden){col.$hidden=FN(col.hidden)(col)===true;col.hidden=true}if(col.hide){col.hidden=col.hide===true;delete col.hide}if(col.options){!col.otext&&(col.otext='text');!col.ovalue&&(col.ovalue='value')}if(col.sort!=null)col.sorting=col.sort;if(cache){var c=cache[i];if(c){col.index=c.index;col.width=c.width;col.hidden=c.hidden}}if(col.index==null)col.index=i;if(col.sorting==null)col.sorting=config.sorting;if(col.alignfilter!=null)col.alignfilter=' '+align(col.alignfilter);if(col.alignheader!=null)col.alignheader=' '+align(col.alignheader);col.sort=0;if(col.search){opt.search=true;col.search=col.search===true?Tangular.compile(col.template):Tangular.compile(col.search)}if(col.align&&col.align!=='left'){col.align=align(col.align);col.align=' '+col.align;if(!col.alignfilter)col.alignfilter=' center';if(!col.alignheader)col.alignheader=' center'}var cls=col.class?(' '+col.class):'';if(col.editable){cls+=' dg-editable';if(col.required)cls+=' dg-required'}var isbool=col.type&&col.type.substring(0,4)==='bool';if(col.template){col.templatecustom=true;col.template=Tangular.compile((col.template.indexOf('<button')===-1?('<div class="dg-value'+cls+'">{0}</div>'):'{0}').format(col.template))}else col.template=Tangular.compile(('<div class="'+(isbool?'dg-bool':'dg-value')+cls+'"'+(config.allowtitles?' title="{{ {1} }}"':'')+'>{{ {0} }}</div>').format(col.name+(col.format!=null?' | format({0}) '.format(typeof(col.format)==='string'?('\''+col.format+'\''):col.format):'')+(col.empty?' | def({0})'.format(col.empty===true||col.empty=='1'?'':('\''+col.empty+'\'')):'')+(isbool?' | ui_datagrid_checkbox':''),col.name));if(col.header)col.header=Tangular.compile(col.header);else col.header=Tangular.compile('{{ text | raw}}');if(!col.text)col.text=col.name;if(col.text.substring(0,1)==='.')col.text='<i class="{0}"></i>'.format(col.text.substring(1));if(col.filter!==false&&!col.filter)col.filter=config.filterlabel;if(col.filtervalue!=null){tmp=col.filtervalue;if(typeof(tmp)==='function')tmp=tmp(col);opt.filter[col.name]=opt.filtervalues[col.id]=tmp}}cols.quicksort('index');opt.cols=cols;self.rebindcss();hbody&&(hbody[0].scrollLeft=0);vbody&&(vbody[0].scrollTop=0)};self.rebindcss=function(){var cols=opt.cols,css=[],indexes={};opt.width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+30;for(var i=0;i<cols.length;i++){var col=cols[i];if(!col.width)col.width=config.colwidth;css.push('.dg-{2} .dg-col-{0}{width:{1}px}'.format(i,col.width,self.IDCSS));if(!col.hidden){opt.width+=col.width;indexes[i]=opt.width}}CSS(css,self.ID);var w=self.width();if(w>opt.width)opt.width=w-2;if(varea){css={width:opt.width};vcontainer.css(css);css.width+=50;varea.css(css)}header&&header.find('.dg-resize').each(function(){var el=$(this);el.css('left',indexes[el.attrd('index')]-39)})};self.cols=function(callback){callback(opt.cols);opt.cols.quicksort('index');self.rebindcss();self.rendercols();opt.rows&&self.renderrows(opt.rows);self.save();opt.cluster&&opt.cluster.update(opt.render);self.resize()};self.rendercols=function(){var Trow='<div class="dg-hrow dg-row-{0}">{1}</div>',column=config.numbering!==false?Theadercol({index:-1,label:config.numbering,filter:false,name:'$',sorting:false}):'';var resize=[];opt.width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+30;if(config.checkbox)column+=Theadercol({index:-1,label:'<div class="dg-checkbox dg-checkbox-main" data-value="-1"><i class="fa fa-check"></i></div>',filter:false,name:'$',sorting:false});for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];if(!col.hidden){var filteritems=col.options?col.options instanceof Array?col.options:GET(col.options):null;var filtervalue=opt.filtervalues[col.id],obj={index:i,ts:NOW.getTime(),label:col.header(col),filter:col.filter,reorder:config.reorder,sorting:col.sorting,name:col.name,alignfilter:col.alignfilter,alignheader:col.alignheader,filterval:filtervalue==null?null:filteritems?filteritems.findValue(col.ovalue,filtervalue,col.otext,'???'):filtervalue,labeltitle:col.title||col.text,options:filteritems};opt.width+=col.width;config.resize&&resize.push('<span class="dg-resize" style="left:{0}px" data-index="{1}"></span>'.format(opt.width-39,i));column+=Theadercol(obj)}}column+='<div class="dg-hcol"></div>';header[0].innerHTML=resize.join('')+Trow.format(0,column);var w=self.width();if(w>opt.width)opt.width=w;var css={width:opt.width};vcontainer.css(css);css.width+=50;varea.css(css);self.redrawsorting()};self.redraw=function(update){var x=hbody[0].scrollLeft,y=vbody[0].scrollTop;isredraw=update?2:1;self.refreshfilter();isredraw=0;hbody[0].scrollLeft=x;vbody[0].scrollTop=y};self.redrawrow=function(row){var index=opt.rows.indexOf(row);if(index!==-1){var el=vbody.find('.dg-row[data-index="{0}"]'.format(index));if(el.length){opt.render[index]=self.renderrow(index,row);el.replaceWith(opt.render[index])}}};self.appendrow=function(row,scroll,prepend){var index=prepend?0:(opt.rows.push(row)-1);var model=self.get();if(model==null){return}else{var arr=model.items?model.items:model;if(prepend){arr.unshift(row)}else if(model.items)arr.push(row);else arr.push(row)}if(prepend){var tmp;for(var i=0;i<opt.render.length;i++){var node=opt.render[i];if(typeof(node)==='string')node=opt.render[i]=$(node)[0];var el=$(node);var tmpindex=i+1;tmp=el.rclass2('dg-row-').aclass('dg-row-'+tmpindex).attrd('index',tmpindex);tmp.find('.dg-number').html(tmpindex+1);tmp.find('.dg-checkbox-main').attrd('value',tmpindex);if(opt.rows[i])opt.rows[i].ROW=tmpindex}row.ROW=index;tmp={};var keys=Object.keys(opt.checked);for(var i=0;i<keys.length;i++)tmp[(+keys[i])+1]=1;opt.checked=tmp;opt.render.unshift(null)}opt.render[index]=$(self.renderrow(index,row))[0];opt.cluster&&opt.cluster.update(opt.render,!opt.scroll||opt.scroll==='-');if(scroll){var el=opt.cluster.el[0];el.scrollTop=el.scrollHeight}self.scrolling()};self.renderrow=function(index,row,plus){if(plus===undefined&&config.exec){var val=self.get();plus=(val.page-1)*val.limit}var Trow='<div><div class="dg-row dg-row-{0}{3}{4}" data-index="{2}">{1}</div></div>',Tcol='<div class="dg-col dg-col-{0}{2}{3}">{1}</div>',column='';if(config.numbering!==false)column+=Tcol.format(-1,'<div class="dg-number">{0}</div>'.format(index+1+(plus||0)));if(config.checkbox)column+=Tcol.format(-1,'<div class="dg-checkbox-main dg-checkbox{1}" data-value="{0}"><i class="fa fa-check"></i></div>'.format(row.ROW,opt.checked[row.ROW]?' dg-checked':''));for(var j=0;j<opt.cols.length;j++){var col=opt.cols[j];if(!col.hidden)column+=Tcol.format(j,col.template(row),col.align,row.CHANGES&&row.CHANGES[col.name]?' dg-col-changed':'')}column+='<div class="dg-col">&nbsp;</div>';var rowcustomclass=opt.rowclasstemplate?opt.rowclasstemplate(row):'';return Trow.format(index+1,column,index,self.selected===row?' dg-selected':'',(row.CHANGES?' dg-row-changed':'')+(rowcustomclass||''))};self.renderrows=function(rows,noscroll){opt.rows=rows;var output=[],plus=0;if(config.exec){var val=self.get();plus=(val.page-1)*val.limit}for(var i=0,length=rows.length;i<length;i++)output.push(self.renderrow(i,rows[i],plus));var min=((opt.height/config.rowheight)>>0)+1;var is=output.length<min;if(is){for(var i=output.length;i<min+1;i++)output.push('<div class="dg-row-empty">&nbsp;</div>')}if(noscroll){self.tclass('dg-noscroll',is);hbody[0].scrollLeft=0;vbody[0].scrollTop=0}opt.render=output;self.onrenderrows&&self.onrenderrows(opt)};self.exportrows=function(page_from,pages_count,callback,reset_page_to,sleep){var arr=[],source=self.get();if(reset_page_to===true)reset_page_to=source.page;if(page_from===true)reset_page_to=source.page;pages_count=page_from+pages_count;if(pages_count>source.pages)pages_count=source.pages;for(var i=page_from;i<pages_count;i++)arr.push(i);!arr.length&&arr.push(page_from);var index=0,rows=[];arr.wait(function(page,next){opt.scroll=(index++)===0?'xy':'';self.get().page=page;self.operation('page');self.onrenderrows=function(opt){rows.push.apply(rows,opt.rows);setTimeout(next,sleep||100)}},function(){self.onrenderrows=null;callback(rows,opt);if(reset_page_to>0){self.get().page=reset_page_to;self.operation('page')}})};self.reordercolumn=function(index,position){var col=opt.cols[index];if(!col)return;var old=col.index;opt.cols[index].index=position+(old<position?0.2:-0.2);opt.cols.quicksort('index');for(var i=0;i<opt.cols.length;i++){col=opt.cols[i];col.index=i}opt.cols.quicksort('index');self.rebindcss();self.rendercols();self.renderrows(opt.rows);opt.sort&&opt.sort.sort&&self.redrawsorting();opt.cluster&&opt.cluster.update(opt.render,true);self.scrolling();config.remember&&self.save()};self.resizecolumn=function(index,size){opt.cols[index].width=size;self.rebindcss();config.remember&&self.save();self.resize()};self.save=function(){var cache={};for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];col.index=i;cache[col.realindex]={index:col.index,width:col.width,hidden:col.hidden}}if(W.PREF)W.PREF.set(self.gridid,cache,'1 month');else CACHE(self.gridid,cache,'1 month')};self.rows=function(){return opt.rows.slice(0)};self.resize=function(){if(!opt.cols||self.dom.offsetParent==null)return;var el,sbw=10;switch(config.height){case'auto':el=self.element;opt.height=(WH-(el.offset().top+config.bottom)-(config.exec?30:-2))+sbw;vbody.css('height',opt.height);break;case'parent':el=self.element.parent();opt.height=(el.height()-config.bottom-(config.exec?30:-2))+sbw;vbody.css('height',opt.height);break;default:if(config.height>0){vbody.css('height',config.height);opt.height=config.height}else{el=self.element.closest(config.height);opt.height=(el.height()-config.bottom-(config.exec?30:-2))+sbw;vbody.css('height',opt.height)}break}var w;if(config.fullwidth_xs&&WIDTH()==='xs'&&isMOBILE){var isfrm=false;try{isfrm=window.self!==window.top}catch(e){isfrm=true}if(isfrm){w=screen.width-(self.element.offset().left*2);self.css('width',w)}}if(w==null)w=self.width();var width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+30;for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];if(!col.hidden)width+=col.width}if(w>width)width=w-2;vcontainer.css('width',width);varea.css('width',width+50);vscrollbararea.css('height',opt.height-1);hscrollbararea.css('width',w);var plus=hbody.offset().top;if(plus<24)plus=24;hbody.css('height',opt.height+50+plus);hcontainer.css('height',opt.height+50+7);opt.width2=w;var hb=hbody[0],issh=((hb.scrollWidth-hb.clientWidth)<5);hscrollbararea.tclass('invisible',issh);self.tclass('dg-scroll-h',!issh);hbody.css('height',(opt.height+50+plus)-sbw);vbody.css('height',opt.height-sbw);hcontainer.css('height',(opt.height+50+7)-sbw);vscrollbararea.css('height',opt.height-1-sbw);setTimeout2(self.ID,function(){var vb=vbody[0],hb=hbody[0],ish=isMOBILE||(hb.scrollWidth-hb.clientWidth)<5;if(!ish){hbody.css('height',(opt.height+50+plus)-sbw);vbody.css('height',opt.height-sbw);hcontainer.css('height',(opt.height+50+7)-sbw);vscrollbararea.css('height',opt.height-1-sbw)}hscrollbar.rclass('invisible');vscrollbar.rclass('invisible');vscrollbararea.tclass('invisible',isMOBILE||(vb.scrollHeight-vb.clientHeight)<5);hscrollbararea.tclass('invisible',ish);var barsize=(w*(w/width))>>0;if(barsize<30)barsize=30;hscrollbar.css('width',barsize);opt.hbarsize=barsize;opt.hbar=!ish;sh.size=barsize;barsize=(opt.height*(opt.height/vb.scrollHeight))>>0;if(barsize<30)barsize=30;sv.size=barsize;vscrollbar.css('height',barsize);opt.vbarsize=barsize;var min=((opt.height/config.rowheight)>>0)+1;var is=(opt.rows?opt.rows.length:0)<min;self.tclass('dg-noscroll',is);vbody[0].scrollTop=vbody[0].scrollTop-1;hbody[0].scrollLeft=hbody[0].scrollLeft-1},500)};self.refreshfilter=function(useraction){var obj=self.get()||EMPTYARRAY;var items=(obj instanceof Array?obj:obj.items)||EMPTYARRAY;var output=[];if(isredraw){if(isredraw===2){self.fn_in_checked();self.fn_in_changed()}}else{opt.checked={};config.checkbox&&header.find('.dg-checkbox-main').rclass('dg-checked');self.fn_in_checked(EMPTYARRAY)}for(var i=0,length=items.length;i<length;i++){var item=items[i];item.ROW=i;if(!config.exec){if(opt.filter&&!self.filter(item))continue;if(opt.search){for(var j=0;j<opt.cols.length;j++){var col=opt.cols[j];if(col.search)item['$'+col.name]=col.search(item)}}}output.push(item)}if(!isredraw){if(opt.scroll){if((/y/).test(opt.scroll))vbody[0].scrollTop=0;if((/x/).test(opt.scroll)){if(useraction){var sl=hbody[0].scrollLeft;hbody[0].scrollLeft=sl?sl-1:0}else hbody[0].scrollLeft=0}opt.scroll=''}if(opt.sort!=null){if(!config.exec)opt.sort.sort&&output.quicksort(opt.sort.name,opt.sort.sort===1);self.redrawsorting()}}self.resize();self.renderrows(output,isredraw);setTimeout(self.resize,100);opt.cluster&&opt.cluster.update(opt.render,!opt.scroll||opt.scroll==='-');self.scrolling();if(isredraw){if(isredraw===2){self.select(self.selected||null)}}else{var sel=self.selected;if(config.autoselect&&output&&output.length){setTimeout(function(){self.select(sel?output.findItem(config.clickid,sel.id):output[0])},1)}else if(opt.operation!=='sort'){self.select(sel?output.findItem(config.clickid,sel.id):null)}else{var tmp=sel?output.findItem(config.clickid,sel.id):null;tmp&&self.select(tmp)}}};self.redrawsorting=function(){self.find('.dg-sorting').each(function(){var el=$(this);var col=opt.cols[+el.attrd('index')];if(col){var fa=el.find('.dg-sort').rclass2('fa-');switch(col.sort){case 1:fa.aclass('fa-arrow-up');break;case 2:fa.aclass('fa-arrow-down');break;default:fa.aclass('fa-sort');break}}})};self.resetcolumns=function(){if(W.PREF)W.PREF.set(self.gridid);else CACHE(self.gridid,null,'-1 day');self.rebind(opt.declaration);self.cols(NOOP);ecolumns.aclass('hidden');isecolumns=false};self.resetfilter=function(){opt.filter={};opt.filtercache={};opt.filtercl={};opt.filtervalues={};opt.cols&&self.rendercols();if(config.exec)self.operation('refresh');else self.refresh()};var pagecache={pages:-1,count:-1};self.redrawpagination=function(){if(!config.exec)return;var value=self.get();var is=false;if(value.page===1||(value.pages!=null&&value.count!=null)){pagecache.pages=value.pages;pagecache.count=value.count;is=true}footer.find('button').each(function(){var el=$(this);var dis=true;switch(this.name){case'page-next':dis=value.page>=pagecache.pages;break;case'page-prev':dis=value.page===1;break;case'page-last':dis=!value.page||value.page===pagecache.pages;break;case'page-first':dis=value.page===1;break}el.prop('disabled',dis)});footer.find('input')[0].value=value.page;if(is){var num=pagecache.pages||0;footer.find('.dg-pagination-pages')[0].innerHTML=num.pluralize.apply(num,config.pluralizepages);num=pagecache.count||0;footer.find('.dg-pagination-items')[0].innerHTML=num.pluralize.apply(num,config.pluralizeitems)}footer.rclass('hidden')};self.setter=function(value,path,type){if(config.exec&&value==null){self.operation('refresh');return}if(value&&value.schema&&schemas.$current!==value.schema){schemas.$current=value.schema;self.rebind(value.schema);setTimeout(function(){self.setter(value,path,type)},100);return}if(!opt.cols)return;opt.checked={};if(forcescroll){opt.scroll=forcescroll;forcescroll=''}else opt.scroll=type!=='noscroll'?'xy':'';self.applycolumns();self.refreshfilter();self.redrawsorting();self.redrawpagination();self.fn_in_changed();!config.exec&&self.rendercols();setTimeout2(self.ID+'resize',self.resize,100);if(opt.cluster)return;config.exec&&self.rendercols();opt.cluster=new Cluster(vbody);opt.cluster.grid=self;opt.cluster.scroll=self.scrolling;opt.render&&opt.cluster.update(opt.render);self.aclass('dg-visible')};self.scrolling=function(){config.checkbox&&setTimeout2(self.ID,function(){vbody.find('.dg-checkbox-main').each(function(){$(this).tclass('dg-checked',opt.checked[this.getAttribute('data-value')]==1)})},80,10)};var REG_STRING=/\/\|\\|,/,REG_DATE1=/\s-\s/,REG_DATE2=/\/|\||\\|,/,REG_SPACE=/\s/g;self.filter=function(row){var keys=Object.keys(opt.filter);for(var i=0;i<keys.length;i++){var column=keys[i],filter=opt.filter[column],val2=opt.filtercache[column],val=row['$'+column]||row[column],type=typeof(val);if(val instanceof Array){val=val.join(' ');type='string'}else if(val&&type==='object'&&!(val instanceof Date)){val=JSON.stringify(val);type='string'}if(type==='number'){if(val2==null)val2=opt.filtercache[column]=self.parseNumber(filter);if(val2.length===1&&val!==val2[0])return false;if(val<val2[0]||val>val2[1])return false}else if(type==='string'){var is=false;if(opt.filtercl[column]!=null){is=opt.filtercl[column]==val;return is}if(val2==null){val2=opt.filtercache[column]=filter.split(REG_STRING).trim();for(var j=0;j<val2.length;j++)val2[j]=val2[j].toSearch()}var s=val.toSearch();for(var j=0;j<val2.length;j++){if(s.indexOf(val2[j])!==-1){is=true;break}}if(!is)return false}else if(type==='boolean'){if(val2==null)val2=opt.filtercache[column]=typeof(filter)==='string'?config.boolean.indexOf(filter.replace(REG_SPACE,''))!==-1:filter;if(val2!==val)return false}else if(val instanceof Date){val.setHours(0);val.setMinutes(0);if(val2==null){val2=filter.trim().replace(REG_DATE1,'/').split(REG_DATE2).trim();var arr=opt.filtercache[column]=[];for(var j=0;j<val2.length;j++){var dt=val2[j].trim();var a=self.parseDate(dt,j===1);if(a instanceof Array){if(val2.length===2){arr.push(j?a[1]:a[0])}else{arr.push(a[0]);if(j===val2.length-1){arr.push(a[1]);break}}}else arr.push(a)}if(val2.length===2&&arr.length===2){arr[1].setHours(23);arr[1].setMinutes(59);arr[1].setSeconds(59)}val2=arr}if(val2.length===1){if(val2[0].YYYYMM)return val.format('yyyyMM')===val2[0].format('yyyyMM');if(val.format('yyyyMMdd')!==val2[0].format('yyyyMMdd'))return false}if(val<val2[0]||val>val2[1])return false}else return false}return true};self.checked=function(){var arr=Object.keys(opt.checked);var output=[],model=self.get()||EMPTYARRAY;var rows=model instanceof Array?model:model.items;for(var i=0;i<arr.length;i++){var index=+arr[i];output.push(rows[index])}return output};self.changed=function(){var output=[],model=self.get()||EMPTYARRAY;var rows=model instanceof Array?model:model.items;for(var i=0;i<rows.length;i++)rows[i].CHANGES&&output.push(rows[i]);return output};self.parseDate=function(val,second){var index=val.indexOf('.');var m,y,d,a,special,tmp;if(index===-1){if((/[a-z]+/).test(val)){var dt;try{dt=NOW.add(val)}catch(e){return[0,0]}return dt>NOW?[NOW,dt]:[dt,NOW]}if(val.length===4)return[new Date(+val,0,1),new Date(+val+1,0,1)]}else if(val.indexOf('.',index+1)===-1){a=val.split('.');if(a[1].length===4){y=+a[1];m=+a[0]-1;d=second?new Date(y,m,0).getDate():1;special=true}else{y=NOW.getFullYear();m=+a[1]-1;d=+a[0]}tmp=new Date(y,m,d);if(special)tmp.YYYYMM=true;return tmp}index=val.indexOf('-');if(index!==-1&&val.indexOf('-',index+1)===-1){a=val.split('-');if(a[0].length===4){y=+a[0];m=+a[1]-1;d=second?new Date(y,m,0).getDate():1;special=true}else{y=NOW.getFullYear();m=+a[0]-1;d=+a[1]}tmp=new Date(y,m,d);if(special)tmp.YYYYMM=true;return tmp}return val.parseDate()};var REG_NUM1=/\s-\s/,REG_COMMA=/,/g,REG_NUM2=/\/|\|\s-\s|\\/;self.parseNumber=function(val){var arr=[],num=val.replace(REG_NUM1,'/').replace(REG_SPACE,'').replace(REG_COMMA,'.').split(REG_NUM2).trim();for(var i=0,length=num.length;i<length;i++){var n=num[i];arr.push(+n)}return arr};self.datagrid_cancel=function(meta,force){var current=self.editable;if(current&&current.is){current.is=false;force&&current.el.replaceWith(current.backup);current.input.off();$(W).off('keydown',current.fn).off('click',current.fn)}};self.datagrid_edit=function(meta,next){if(!meta||!meta.col.editable)return;if(!self.editable)self.editable={};var el=meta.elcol,current=self.editable;current.is&&self.datagrid_cancel(meta,true);current.is=true;current.backup=el.find('.dg-editable').aclass('dg-editable').clone();el=el.find('.dg-editable');if(!meta.col.type){if(meta.value instanceof Date)meta.col.type='date';else meta.col.type=typeof(meta.value)}if(meta.col.options){current.el=el;var opt={};opt.element=el;opt.items=meta.col.options;opt.key=meta.col.otext;opt.placeholder=meta.col.dirsearch?meta.col.dirsearch:'';if(meta.col.dirsearch===false)opt.search=false;opt.callback=function(item){current.is=false;meta.value=item[meta.col.ovalue];next(meta);self.datagrid_cancel(meta)};SETTER('directory','show',opt);return}var align=meta.col.align;el.rclass('dg-value').html(meta.col.type.substring(0,4)==='bool'?'<div{1}><div class="dg-checkbox{0}" data-custom="2"><i class="fa fa-check"></i></div></div>'.format(meta.value?' dg-checked':'',align?(' class="'+align.trim()+'"'):''):'<input type="{0}" maxlength="{1}"{2} />'.format(meta.col.ispassword?'password':'text',meta.col.maxlength||100,align?(' class="'+align.trim()+'"'):''));current.el=el;var input=meta.elcol.find('input');input.val(meta.value instanceof Date?meta.value.format(meta.col.format):meta.value);input.focus();current.input=input;if(meta.col.type==='date'){var opt={};opt.element=el;opt.value=meta.value;opt.callback=function(date){current.is=false;meta.value=date;next(meta);self.datagrid_cancel(meta)};SETTER('datepicker','show',opt)}current.fn=function(e){if(!current.is)return;if(e.type==='click'){if(e.target.tagName==='INPUT')return;e.preventDefault();e.keyCode=13;if(meta.col.type==='date'){e.type='keydown';setTimeout(current.fn,800,e);return}else if(meta.col.type.substring(0,4)==='bool'){var tmp=$(e.target);var is=tmp.hclass('dg-checkbox');if(!is){tmp=tmp.closest('.dg-checkbox');is=tmp.length}if(is){meta.value=tmp.hclass('dg-checked');next(meta);self.datagrid_cancel(meta);return}}}switch(e.keyCode){case 13:case 9:var val=input.val();if(val==meta.value){next=null;self.datagrid_cancel(meta,true)}else{if(meta.col.type==='number'){val=val.parseFloat();if(val==meta.value||(meta.min!=null&&meta.min>val)||(meta.max!=null&&meta.max<val)){next=null;self.datagrid_cancel(meta,true);return}}else if(meta.col.type==='date'){val=val.parseDate(meta.format?meta.format.env():undefined);if(!val||isNaN(val.getTime()))val=null;if(val&&meta.value&&val.getTime()===meta.value.getTime()){next=null;self.datagrid_cancel(meta,true);return}}if(meta.col.required&&(val==null||val==='')){self.datagrid_cancel(meta,true);return}meta.value=val;next(meta);self.datagrid_cancel(meta)}if(e.which===9){var elcol=meta.elcol;while(true){elcol=elcol.next();if(!elcol.length)break;var eledit=elcol.find('.dg-editable');if(eledit.length){setTimeout(function(){self.editcolumn(meta.rowindex,+elcol.attr('class').match(/\d+/)[0])},200);break}}}break;case 27:next=null;self.datagrid_cancel(meta,true);break}};$(W).on('keydown',current.fn).on('click',current.fn)}});</script>