<style>.ui-dynamicvaluelist-label{margin-bottom:3px;font-size:12px;text-align:left}.ui-dynamicvaluelist-label i{margin-right:5px}.ui-dynamicvaluelist-item{height:32px;border-top:1px solid #E0E0E0;background-color:#FFF;cursor:pointer;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;color:#777}.ui-dynamicvaluelist-item:first-child{border-top:0}.ui-dynamicvaluelist-border>.ui-dynamicvaluelist-item:last-child{border-top:0;border-radius:var(--radius)}.ui-dynamicvaluelist-border{border:1px solid #E0E0E0;border-radius:var(--radius)}.ui-dynamicvaluelist-is .ui-dynamicvaluelist-border>.ui-dynamicvaluelist-item:last-child{border-top-left-radius:0;border-top-right-radius:0}.ui-dynamicvaluelist-value{cursor:pointer;display:block;padding:9px 7px 0 5px;margin-right:32px;user-select:none;-webkit-user-select:none;-moz-user-select:none;font:normal 13px Arial;color:gray;text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.ui-dynamicvaluelist-icon{color:#000;cursor:pointer;width:32px;float:right;border-left:1px solid #E0E0E0;height:32px;text-align:center;padding:6px 0 0}.ui-dynamicvaluelist-is .ui-dynamicvaluelist-container .ui-dynamicvaluelist-value{color:#000}.ui-dynamicvaluelist-is .ui-dynamicvaluelist-container .ui-dynamicvaluelist-item:first-child{border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}.ui-dynamicvaluelist-is .fa-times{color:red}.ui-dynamicvaluelist-container{border-bottom:1px solid #E0E0E0}.ui-dynamicvaluelist-required .ui-dynamicvaluelist-label{font-weight:bold}.ui-dynamicvaluelist-required .ui-dynamicvaluelist-label:before{color:red;content:'***';margin-right:5px}.ui-dynamicvaluelist-required .ui-dynamicvaluelist-icon{border-left-color:#D0D0D0}.ui-dynamicvaluelist-required .ui-dynamicvaluelist{border-color:#D0D0D0}.ui-dynamicvaluelist-invalid .ui-dynamicvaluelist{border:1px solid red}.ui-dynamicvaluelist-invalid .ui-dynamicvaluelist-icon{border-left-color:red;color:red}.ui-disabled .ui-dynamicvaluelist *{cursor:not-allowed}.ui-disabled .ui-dynamicvaluelist{background-color:#F0F0F0}.ui-disabled .ui-dynamicvaluelist-value{color:gray}.ui-disabled .ui-dynamicvaluelist-icon i{color:gray !important}.ui-dark .ui-dynamicvaluelist-item{border-color:#3A3A3A;background-color:#202020;color:#707070}.ui-dark .ui-dynamicvaluelist-border{border-color:#404040}.ui-dark .ui-dynamicvaluelist-container{border-bottom-color:#404040}.ui-dark .ui-dynamicvaluelist-icon{border-left-color:#3A3A3A;color:#707070}.ui-dark .ui-dynamicvaluelist-is .ui-dynamicvaluelist-container .ui-dynamicvaluelist-value{color:#FFF}.ui-dark .ui-dynamicvaluelist-required .ui-dynamicvaluelist-label:before{color:red}.ui-dark .ui-dynamicvaluelist-required .ui-dynamicvaluelist-icon{border-color:#424242}.ui-dark .ui-dynamicvaluelist-required .ui-dynamicvaluelist{border-color:#424242}.ui-dark .ui-dynamicvaluelist-invalid .ui-dynamicvaluelist{border-color:red !important;background-color:#202020 !important}.ui-dark .ui-dynamicvaluelist-invalid .ui-dynamicvaluelist-icon{border-left-color:red;color:red}.ui-dark .ui-disabled .ui-dynamicvaluelist{background-color:#282828}.ui-dark .ui-disabled .ui-dynamicvaluelist-value{color:#777}</style>
<script>COMPONENT('dynamicvaluelist','html:{{ name}};icon2:angle-down;loading:1;limit:1000;dirvalue:id',function(self,config,cls){var cls2='.'+cls,template='<div class="{0}-item"><div class="{0}-icon"><i class="fa fa-times"></i></div><div class="{0}-value">{1}</div></div>'.format(cls,config.placeholder);var container,skip=false;self.nocompile();self.bindvisible(50);self.validate=function(value){return!config.required||config.disabled?true:!!value};self.state=function(type){if(type){var invalid=config.required?self.isInvalid():false;if(invalid!==self.$oldstate){self.$oldstate=invalid;self.tclass(cls+'-invalid',invalid)}}};self.configure=function(key,value){switch(key){case'html':config.html=Tangular.compile(value);break;case'label':var label=self.find(cls2+'-label');label.tclass('hidden',!value);label.find('span').html((value||'')+':');break;case'required':self.noValid(!value);!value&&self.state(1,1);self.tclass(cls+'-required',value);break;case'disabled':self.tclass('ui-disabled',value);break;case'icon':var fa=self.find(cls2+'-label').find('i');fa.rclass2('fa-').rclass('hidden');if(value)fa.aclass('fa-'+value);else fa.aclass('hidden');break;case'remap':config.remap=value?FN(value):null;break}};self.make=function(){if(!config.label)config.label=self.html();self.aclass(cls);self.html('<div class="{0}-label{1}"><i class="fa hidden"></i><span>{2}:</span></div><div class="{0}-border"><div class="{0}-container hidden"></div>{3}</div>'.format(cls,config.label?'':' hidden',config.label,template.replace('-item','-item '+cls+'-search').replace('fa-times','fa-'+config.icon2)));container=self.find(cls2+'-container');self.event('click',cls2+'-item',function(){if(config.disabled)return;var t=this;if(config.dirsource){var opt={};opt.element=$(t);opt.offsetY=-1;opt.placeholder=config.dirplaceholder;opt.render=config.dirrender?GET(self.makepath(config.dirrender)):null;opt.custom=!!config.dircustom;opt.offsetWidth=2;opt.minwidth=config.dirminwidth||200;opt.maxwidth=config.dirmaxwidth;opt.key=config.dirkey||config.key;opt.empty=config.dirempty;opt.key=config.dirkey;var model=self.get();var key=config.key||config.dirvalue;opt.items=function(value,next){var processor=function(values){if(model&&model.length){var arr=[];for(var i=0;i<values.length;i++){if(model.indexOf(values[i][key])===-1)arr.push(values[i])}values=arr}next(values)};if(config.dirsource.indexOf(' ')!==-1){var val=encodeURIComponent(value);AJAX(config.dirsource.format(val).arg({value:val}),processor)}else EXEC(self.makepath(config.dirsource),[value],processor)};opt.callback=function(selected){var val=selected[config.dirvalue],arr=self.get()||[];if(arr.indexOf(val)!==-1)return;skip=true;self.bindsinglevalue([val],t.$dlid);if(t.$dlid)self.update();else{arr.push(val);self.set(arr)}self.change();config.required&&setTimeout(self.validate2,100)};SETTER('directory/show',opt)}else{EXEC(self.makepath(config.click||config.find),self.element,function(value){var arr=self.get()||[];if(arr.indexOf(value)!==-1)return;skip=true;if(t.$dlid)self.update();else{arr.push(value);self.set(arr)}self.change();config.required&&setTimeout(self.validate2,100);self.bindsinglevalue([value],t.$dlid)},self.get())}});self.event('click',cls2+'-icon',function(e){e.preventDefault();e.stopPropagation();if(!config.disabled){var el=$(this).closest(cls2+'-item');if(el[0].$dlid){var source=self.get();var index=source.indexOf(el[0].$dlid);if(index!==-1){skip=true;source.splice(index,1);container.tclass('hidden',!source.length);self.change();self.update()}el.remove()}else el.trigger('click')}})};self.bindvalue=function(value){if(!value)value=[];config.bind&&SEEX(self.makepath(config.bind),value);if(config.remap){for(var i=0;i<value.length;i++)value[i]=config.remap(value[i])}container.empty();for(var i=0;i<value.length;i++)el_insert(value[i]);self.tclass(cls+'-is',!!value.length);container.tclass('hidden',!value.length);config.loading&&SETTER('loading/hide',200)};var el_update=function(item,value){var arr=container.find(cls2+'-item');var key=config.key||config.dirvalue;for(var i=0;i<arr.length;i++){if(arr[i].$dlid===value){var model=self.get();var index=model.indexOf(value);if(index!==-1){model[index]=item[key];skip=true;self.update();self.change()}arr[i].$dlid=item[key];$(arr[i]).find(cls2+'-value').html(config.html(item));break}}};var el_insert=function(item){var el=$(template);el[0].$dlid=item[config.key||config.dirvalue];el.find(cls2+'-value').html(config.html(item));container[0].appendChild(el[0])};self.bindsinglevalue=function(value,oldid){if(value){if(config.url){config.loading&&SETTER('loading/show');var val=encodeURIComponent(value.join(','));AJAX('GET '+config.url.format(val).arg({value:val}),function(response){config.loading&&SETTER('loading/hide');if(response instanceof Array&&response.length){if(oldid==null)el_insert(response[0]);else el_update(response[0],oldid);container.rclass('hidden')}})}else{EXEC(self.makepath(config.exec||config.read),value,function(response){if(response instanceof Array&&response.length){if(oldid==null)el_insert(response[0]);else el_update(response[0],oldid);container.rclass('hidden')}})}}};self.setter=function(value,path,type){if(skip){skip=false;self.tclass(cls+'-is',value&&value.length>0);return}if(value&&value.length){if(config.url){config.loading&&SETTER('loading/show');var val=encodeURIComponent(value.join(','));AJAX('GET '+config.url.format(val).arg({value:val}),self.bindvalue)}else EXEC(self.makepath(config.exec||config.read),value,self.bindvalue,type)}else self.bindvalue(value)}});</script>